#!/usr/bin/env just --justfile
# https://github.com/casey/just

set shell := ["bash", "-cu"]



build-jar :
	./gradlew jar



dependencies-tree :
	./gradlew dependencies --configuration testCompileOnly

extract-all-jars :
	rm -r -f jar-files
	./gradlew extractAllJars
	find jar-files -type f -name lint.jar -print -delete
	for i in jar-files/*; do mv "$i" "jar-files/$(basename "$i" | tr " ()" "_")_"; done

super-files-tree :
	tree -N -d super-files

super-files :
	rm -r -f super-files
	just dependencies-tree
	just extract-all-jars
	mv -f -v jar-files super-files
	just super-files-tree

jar-files-tree :
	tree -N -d jar-files

jar-files :
	just dependencies-tree
	just extract-all-jars
	for i in super-files/*; do rm -r -f "jar-files/$(basename "$i")"; done
	just jar-files-tree



reset :
	@rm -r -f out jar-files super-files
	@mkdir -p out jar-files super-files

reset-out :
	@rm -r -f out
	@mkdir -p out

reset-out-android :
	@touch out/android.d.ts
	@truncate -s0 out/android.d.ts

fix-out-android output :
	sed -i -e '/<clinit>/d' out/android.d.ts
	sed -i -e 's/<set-?>:/param0:/' out/android.d.ts
	sed -i -e 's/<any;/<any>;/' out/android.d.ts
	sed -i -e 's/$.*(/(/' out/android.d.ts
	sed -i -e 's/^export class module-info /declare class ModuleInfo /' -e 's/java.lang.Class<module-info>/java.lang.Class<ModuleInfo>/' out/android.d.ts
# lib="$(echo "{{output}}" | grep --only-matching '_.*_' | sed -e 's/_//g' -e 's/-/_/g')"; \
# [[ -n "$lib" ]] && echo \n"ðŸŒ• lib -> '$lib'" && sed -i -e 's/$$lib.*(/(/'

out-tree :
	tree -N out

out-each :
	just reset-out
	for i in jar-files/*; do \
		output="$(basename "$i" | grep --only-matching '__.*__' | sed -e 's/__//g').d.ts"; \
		if [[ -e "../out/$output" ]]; then \
			cp -f -v -t out "../out/$output"; \
		else \
			just out-single "$(basename "$i")" "$output"; \
		fi; \
	done
	@rm -f out/android.d.ts
	just out-tree

out-single input output :
	just reset-out-android
	-java -jar build/libs/dts-generator.jar \
		-skip-declarations \
		-input-generics ../libs/generics.txt \
		-super $ANDROID_HOME/platforms/android-29/android.jar \
		-super super-files \
		-super jar-files \
		-input "jar-files/{{input}}"
	just fix-out-android "{{output}}"
	mv -f -v out/android.d.ts "out/{{output}}"
	cp -f -v -t ../out "out/{{output}}"

out-multi output +inputs :
	just reset-out
	just reset-out-android
	-java -jar build/libs/dts-generator.jar \
		-skip-declarations \
		-input-generics ../libs/generics.txt \
		-super $ANDROID_HOME/platforms/android-29/android.jar \
		-super super-files \
		-super jar-files \
		-input {{inputs}}
	just fix-out-android "{{output}}.d.ts"
	mv -f -v out/android.d.ts "out/{{output}}.d.ts"
	just out-tree

out-all :
	just reset-out
	just reset-out-android
	java -jar build/libs/dts-generator.jar \
		-skip-declarations \
		-input-generics ../libs/generics.txt \
		-super $ANDROID_HOME/platforms/android-29/android.jar \
		-super super-files \
		-super jar-files \
		-input jar-files
	just out-tree

export-out target :
	just out-tree
	rm -r -f -v "{{target}}"
	mkdir -p -v "{{target}}"
	cp -f -r -v -t "{{target}}" out/*.d.ts



out-tsc :
	tsc --noEmit --listFilesOnly --diagnostics

watch-src :
	watchexec --watch src --restart -- 'just on-watch-src'
on-watch-src :
	printf "\ec\e[3J"
	just build-jar
	just out-each
	tsc --noEmit
	bat out/android.d.ts



android-platform version :
	just reset-out
	just reset-out-android
	java -jar build/libs/dts-generator.jar \
		-input $ANDROID_HOME/platforms/android-{{version}}/android.jar
	just fix-out-android "android-platform-{{version}}.d.ts"
	mv -f -v out/android.d.ts ../out/android-platform-{{version}}.d.ts

androidx version :
	just reset-out
	just reset-out-android
	java -jar build/libs/dts-generator.jar \
		-skip-declarations \
		-input-generics ../libs/generics.txt \
		-super $ANDROID_HOME/platforms/android-{{version}}/android.jar \
		-input super-files
	just fix-out-android "androidx-{{version}}.d.ts"
	mv -f -v out/android.d.ts ../out/androidx-{{version}}.d.ts





# mv -v out/android.d.ts "out/$(echo "{{input}}" | rg --only-matching '__(.*)__' --replace '$1').d.ts"
# mv -v out/android.d.ts "out/$(echo "{{input}}" | sed -E 's/__(.*)__/\1/').d.ts"
# mv -v out/android.d.ts "out/$(echo "{{input}}" | grep -E '__(.*)__').d.ts"
# mv -v out/android.d.ts "out/$(echo "{{input}}" | grep --only-matching '__.*__' | sed -e 's#^__##' -e 's#__$##').d.ts"
# mv -v out/android.d.ts "out/$(echo "{{input}}" | tr -cs "[:alpha:]" "_").d.ts"
# fd -uu --search-path=super-files --type=directory --max-depth=1 --exec rm -rf "jar-files/{/}"
# fd -uu --search-path=jar-files --type=file --glob "lint.jar" --exec rm -rfv
